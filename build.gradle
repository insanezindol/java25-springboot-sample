plugins {
    id 'java'
    id 'org.springframework.boot' version '4.0.1'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'org.asciidoctor.jvm.convert' version '4.0.5'
    id 'jacoco'
}

group = 'com.example'
version = '0.0.1-SNAPSHOT'
description = 'java25-springboot-sample'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(25)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

ext {
    set('snippetsDir', file("build/generated-snippets"))
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    implementation 'org.springframework.boot:spring-boot-starter-kafka'
    implementation 'org.springframework.boot:spring-boot-starter-webmvc'
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:3.0.1'
    implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310'
    implementation("com.navercorp.fixturemonkey:fixture-monkey:1.1.15")
    implementation("com.google.code.gson:gson:2.13.2")
    compileOnly 'org.projectlombok:lombok'
    runtimeOnly 'com.mysql:mysql-connector-j'
    runtimeOnly 'io.micrometer:micrometer-registry-prometheus'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-data-elasticsearch-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-data-jpa-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-data-redis-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-kafka-test'
    testImplementation 'org.springframework.boot:spring-boot-starter-webmvc-test'
    testImplementation 'org.projectlombok:lombok'
    testAnnotationProcessor 'org.projectlombok:lombok'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
}

// ========== Jacoco ì„¤ì • ì‹œì‘ ==========
jacoco {
    toolVersion = "0.8.14"
}

tasks.named('test') {
    outputs.dir snippetsDir
    useJUnitPlatform()
    finalizedBy jacocoTestReport // í…ŒìŠ¤íŠ¸ í›„ ë¦¬í¬íŠ¸ ìë™ ìƒì„±
}

// Jacoco ë¦¬í¬íŠ¸ ìƒì„± ì„¤ì •
jacocoTestReport {
    dependsOn test

    reports {
        xml.required = true  // SonarQube ë“±ì—ì„œ ì‚¬ìš©
        html.required = true // HTML ë¦¬í¬íŠ¸ ìƒì„±
        csv.required = false
    }

    // ì œì™¸í•  í´ë˜ìŠ¤ ì„¤ì • (Mavenì˜ excludesì™€ ë™ì¼)
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                    '**/*Application.class'          // Application í´ë˜ìŠ¤ ì œì™¸
            ])
        }))
    }

    doLast {
        println "\nâœ… Jacoco ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:"
        println "ğŸ“Š HTML ë¦¬í¬íŠ¸: build/reports/jacoco/test/html/index.html"
    }
}

// Jacoco ì»¤ë²„ë¦¬ì§€ ê²€ì¦ ì„¤ì • (Mavenì˜ check goalê³¼ ë™ì¼)
jacocoTestCoverageVerification {
    dependsOn test
    mustRunAfter jacocoTestReport

    violationRules {
        rule {
            enabled = true
            element = 'BUNDLE' // ì „ì²´ í”„ë¡œì íŠ¸

            limit {
                counter = 'LINE'           // ë¼ì¸ ì»¤ë²„ë¦¬ì§€
                value = 'COVEREDRATIO'     // ì»¤ë²„ëœ ë¹„ìœ¨
                minimum = 0.30             // 30% ì´ìƒ
            }

            // ì¶”ê°€ ì»¤ë²„ë¦¬ì§€ ê·œì¹™ (ì„ íƒì‚¬í•­)
            limit {
                counter = 'BRANCH'         // ë¸Œëœì¹˜ ì»¤ë²„ë¦¬ì§€
                value = 'COVEREDRATIO'
                minimum = 0.10             // 10% ì´ìƒ
            }

            limit {
                counter = 'METHOD'         // ë©”ì†Œë“œ ì»¤ë²„ë¦¬ì§€
                value = 'COVEREDRATIO'
                minimum = 0.30             // 30% ì´ìƒ
            }

            limit {
                counter = 'CLASS'          // í´ë˜ìŠ¤ ì»¤ë²„ë¦¬ì§€
                value = 'COVEREDRATIO'
                minimum = 0.50             // 50% ì´ìƒ
            }
        }
    }

    // ë¦¬í¬íŠ¸ì™€ ë™ì¼í•œ ì œì™¸ ì„¤ì • ì ìš©
    afterEvaluate {
        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: [
                    '**/*Application.class'
            ])
        }))
    }
}

// ë¹Œë“œ ìˆœì„œ ì •ì˜
tasks.named('check') {
    dependsOn jacocoTestCoverageVerification
}

// build íƒœìŠ¤í¬ì— check í¬í•¨
tasks.named('build') {
    dependsOn 'check'
}

tasks.named('asciidoctor') {
    inputs.dir snippetsDir
    dependsOn test
}
